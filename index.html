<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>jootubemusic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="logo"><span>joo</span>tubemusic</div>
    <div class="header-sub">
      Last.fm + YouTube 플레이어
    </div>
  </header>

  <main>
    <div class="search-bar">
      <input
        id="searchInput"
        type="text"
        placeholder="앨범, 아티스트, 플레이리스트를 검색하세요"
      />
      <button id="searchBtn">검색</button>
    </div>

    <div class="info">
      검색 버튼을 눌러 Last.fm에서 앨범을 찾고, 원하는 앨범을 선택해 내 그리드에 추가할 수 있습니다.
    </div>

    <!-- 내가 고른 앨범 그리드 -->
    <section class="section-my">
      <h2 class="section-title">내 앨범</h2>
      <div id="myGrid" class="grid"></div>
      <div id="empty" class="empty">아직 선택한 앨범이 없습니다.</div>
    </section>
  </main>

  <!-- 검색 결과 모달 -->
  <div id="searchModal" class="modal" style="display:none;">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <span id="modalTitle">검색 결과</span>
        <button id="modalClose" class="modal-close">×</button>
      </div>
      <div id="modalGrid" class="grid"></div>
    </div>
  </div>

    <!-- 앨범 트랙 모달 -->
  <div id="trackModal" class="modal" style="display:none;">
    <div class="modal-backdrop" id="trackBackdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <span id="trackModalTitle">앨범 트랙</span>
        <button id="trackModalClose" class="modal-close">×</button>
      </div>
      <ul id="trackList" class="track-list"></ul>
    </div>
  </div>

  <!-- 미니 플레이어 -->
  <div class="mini-player" id="miniPlayer" style="display:none;">
    ...

  <!-- 미니 플레이어 -->
  <div class="mini-player" id="miniPlayer" style="display:none;">
    <img id="miniCover" class="mini-cover" src="" alt="" />
    <div class="mini-meta">
      <div id="miniTitle" class="mini-meta-title"></div>
      <div id="miniArtist" class="mini-meta-artist"></div>
    </div>
    <button class="mini-btn" id="miniToggle">▶</button>
    <button class="mini-btn" id="miniHide">×</button>
  </div>

  <script>
    const LASTFM_API_KEY = '7e0b8eb10fdc5cf81968b38fdd543cff';

    const searchInput = document.getElementById('searchInput');
    const searchBtn   = document.getElementById('searchBtn');

    const myGrid      = document.getElementById('myGrid');
    const empty       = document.getElementById('empty');

    const searchModal   = document.getElementById('searchModal');
    const modalGrid     = document.getElementById('modalGrid');
    const modalClose    = document.getElementById('modalClose');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle    = document.getElementById('modalTitle');

    const miniPlayer  = document.getElementById('miniPlayer');
    const miniCover   = document.getElementById('miniCover');
    const miniTitle   = document.getElementById('miniTitle');
    const miniArtist  = document.getElementById('miniArtist');
    const miniToggle  = document.getElementById('miniToggle');
    const miniHide    = document.getElementById('miniHide');

    let isPlaying = false;
    let myAlbums = []; // 내가 선택한 앨범 목록

    function openModal(query) {
      modalTitle.textContent = `"${query}" 검색 결과`;
      searchModal.style.display = 'flex';
    }

    function closeModal() {
      searchModal.style.display = 'none';
      modalGrid.innerHTML = '';
    }

    async function searchAlbums(query) {
      const url = new URL('https://ws.audioscrobbler.com/2.0/');
      url.searchParams.set('method', 'album.search');
      url.searchParams.set('album', query);
      url.searchParams.set('api_key', LASTFM_API_KEY);
      url.searchParams.set('format', 'json');
      url.searchParams.set('limit', '50');

      const res = await fetch(url.toString());
      if (!res.ok) throw new Error('Last.fm 요청 실패: ' + res.status);
      const data = await res.json();
      return data.results?.albummatches?.album || [];
    }

    function pickAlbumImage(album) {
      const images = Array.isArray(album.image) ? album.image : [];
      let imgUrl = '';

      if (images.length) {
        const preferSizes = ['extralarge', 'large', 'medium', 'small'];
        for (const size of preferSizes) {
          const found = images.find((img) => img.size === size && img['#text']);
          if (found && found['#text']) {
            imgUrl = found['#text'];
            break;
          }
        }
      }
      if (!imgUrl) {
        imgUrl = 'https://via.placeholder.com/300x300.png?text=%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%86%EC%9D%8C';
      }
      if (imgUrl.startsWith('http://')) {
        imgUrl = imgUrl.replace('http://', 'https://');
      }
      return imgUrl;
    }

    // 검색 결과를 모달 안에 렌더링
    function renderSearchResults(albums) {
      modalGrid.innerHTML = '';

      if (!albums.length) {
        const div = document.createElement('div');
        div.className = 'empty';
        div.textContent = '검색 결과가 없습니다.';
        modalGrid.appendChild(div);
        return;
      }

      albums.forEach((album) => {
        const card = document.createElement('div');
        card.className = 'card';

        const title = album.name || '제목 없음';
        const artist = album.artist || '아티스트 없음';
        const imgUrl = pickAlbumImage(album);

        card.innerHTML = `
          <img src="${imgUrl}" alt="${title}">
          <div class="card-title"><span>${title}</span></div>
          <div class="card-artist">${artist}</div>
        `;

        card.addEventListener('click', () => {
          const exists = myAlbums.some(
            (a) => a.name === title && a.artist === artist
          );
          if (!exists) {
            myAlbums.push({
              name: title,
              artist,
              image: imgUrl,
            });
            renderMyAlbums();
          }
          showMiniPlayer({
            title,
            artist,
            cover: imgUrl,
          });
          // 필요하면 여기서 모달을 닫아도 됨
          // closeModal();
        });

        modalGrid.appendChild(card);
      });
    }

    function renderMyAlbums() {
      myGrid.innerHTML = '';

      if (!myAlbums.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      myAlbums.forEach((album, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${album.image}" alt="${album.name}">
          <div class="card-title"><span>${album.name}</span></div>
          <div class="card-artist">${album.artist}</div>
        `;
        card.addEventListener('click', () => {
          showMiniPlayer({
            title: album.name,
            artist: album.artist,
            cover: album.image,
          });
        });
        myGrid.appendChild(card);
      });
    }

    async function handleSearch() {
      const q = searchInput.value.trim();
      if (!q) return;

      console.log('[jootubemusic] search:', q);
      openModal(q);
      modalGrid.innerHTML = '<div class="empty">검색 중...</div>';

      try {
        const albums = await searchAlbums(q);
        console.log('Last.fm albums:', albums);
        renderSearchResults(albums);
      } catch (err) {
        console.error(err);
        modalGrid.innerHTML = '<div class="empty">검색 중 오류가 발생했습니다.</div>';
      }
    }

    function showMiniPlayer(track) {
      miniCover.src = track.cover;
      miniTitle.textContent = track.title;
      miniArtist.textContent = track.artist;
      isPlaying = true;
      miniToggle.textContent = '⏸';
      miniPlayer.style.display = 'flex';
    }

    miniToggle.addEventListener('click', () => {
      isPlaying = !isPlaying;
      miniToggle.textContent = isPlaying ? '⏸' : '▶';
    });

    miniHide.addEventListener('click', () => {
      miniPlayer.style.display = 'none';
      isPlaying = false;
    });

    searchBtn.addEventListener('click', handleSearch);
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleSearch();
    });

    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    renderMyAlbums();
  </script>
</body>
</html>
